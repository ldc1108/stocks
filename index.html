<!DOCTYPE html>
<html>
	<head>
	</head>
	<body>
		<!-- DOM Elements -->
			<form class="inputs">
				<input type="text"></input>
				<button type="submit">Display</button>
			</form>
			
		<!-- Imports -->
		<script src="bootstrap.min.js"></script>
		<script src="QuoteService.js"></script>
		<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
		<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
		<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
		
		<!-- Scripts -->
		<script type="text/javascript">
			$(document).ready(function() {
				$("button").button();
				$("form").submit(function(e) {
					e.preventDefault();
					var tick = $("input").val();
					new Markit.QuoteService(tick, function(jsonResult) {
						this.clearResult();
						//Catch errors
						$("p").text("About to if..");
						if (!jsonResult.Data || jsonResult.Message){
							this.renderAlert(jsonResult);
							return;
						}
						this.success(jsonResult);
					});					
				});
			});
			
	// Prototype some methods onto our Quote Service
	Markit.QuoteService.prototype.clearResult = function(){
		$("p").text("clearResult");
		this.resetForm();
		$("#resultContainer").remove();
		$("div.alert").remove();
	};

	Markit.QuoteService.prototype.resetForm = function(){
		$("p").text("resetForm");
		$("button").button("refresh");
		$("form").removeClass("error");
		$("input")
			.val($("input").val().toUpperCase())
			.select()
			.focus();	
	};

	Markit.QuoteService.prototype.success = function(jsonResult){
		var $container = $("<div class='hide' id='resultContainer' />");
		$container.append("<h4>"+jsonResult.Data.Name+" ("+jsonResult.Data.Symbol+")</h4>");
		$container.append(this.renderResultTable(jsonResult));

		$("form").after($container);
		$container.fadeIn('fast');
		this.resetForm();
	};

	Markit.QuoteService.prototype.renderAlert = function(jsonResult){
		$("form").addClass("error");
		$("form").before("<div class='alert alert-error'><a class='close' data-dismiss='alert'>&times;</a>"+jsonResult.Message+"</div>");
		$("div.alert").alert();
	};

	Markit.QuoteService.prototype.renderResultTable = function(jsonResult){
		var $table = $("<table />"),
			$thead = $("<thead />"),
			$tbody = $("<tbody />"),
			tableHeadCells = [];
			tableCells = [];
		
		tableHeadCells.push("<tr>");
		tableHeadCells.push("<th>Last Price</th>");
		tableHeadCells.push("<th>Change</th>");
		tableHeadCells.push("<th>Change Percent</th>");
		tableHeadCells.push("<th>Change Percent YTD</th>");
		tableHeadCells.push("<th>Last Traded</th>");
		tableHeadCells.push("</tr>");

		tableCells.push("<tr>");
		tableCells.push("<td>$",jsonResult.Data.LastPrice,"</td>");
		tableCells.push("<td>",this.formatChgPct(jsonResult.Data.Change),"</td>");
		tableCells.push("<td>",this.formatChgPct(jsonResult.Data.ChangePercent),"%</td>");
		tableCells.push("<td>",jsonResult.Data.ChangePercentYTD.toFixed(2),"%</td>");
		tableCells.push("<td>",jsonResult.Data.Timestamp,"</td>");
		tableCells.push("</tr>");

		$table.addClass("table table-bordered table-striped");			
		$thead.append(tableHeadCells.join(""));
		$tbody.append(tableCells.join(""));

		$table.append($thead).append($tbody);

		return $table;
	};

	Markit.QuoteService.prototype.formatChgPct = function(chg){
		//the quote API returns negative numbers already,
		//so we just need to add the + sign to positive numbers
		return (chg <= 0) ? chg.toFixed(2) : "+" + chg.toFixed(2);	
	};
	
	</script>
	</body>
</html>